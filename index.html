
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Work Order Linked Cost Allocation Standings</title>
  <link rel="preconnect" href="https://alcdn.msauth.net"/>
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <style>
    :root {
      --bg:#f6f7fb; --card:#ffffff; --text:#1b1d2a; --muted:#697386; --primary:#0d6efd; --border:#e7e9ef;
      --shadow:0 2px 8px rgba(0,0,0,0.06);
    }
    * { box-sizing:border-box; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; background:var(--bg); color:var(--text); }
    header.appbar { display:flex; justify-content:space-between; align-items:center; padding:10px 14px; font-weight:600; font-size:14px; }
    .brand { color:#0b3; }
    .company { display:flex; align-items:center; gap:8px; }
    .company img { height:22px; width:auto; border-radius:4px; }

    .container { max-width:1000px; margin:0 auto; padding: 8px 14px 76px; }

    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:16px; margin-bottom:16px; }
    .hero h1 { margin:0 0 6px 0; font-size:22px; font-weight:800; }
    .hero p { margin:0; color:var(--muted); }
    .btn { display:inline-flex; align-items:center; gap:8px; background:var(--primary); color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:600; box-shadow:var(--shadow); }
    .btn.secondary { background:#6c757d; }
    .btn.ghost { background:#eef3ff; color:#1b3; }

    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#eef2f8; color:#445; font-size:12px; border:1px solid var(--border); }
    .pill.success { background:#e9f7ef; color:#0a7; border-color:#cdebd7; }
    .pill.warn { background:#fff4e5; color:#c77; border-color:#ffe0b3; }

    .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .metric h3 { margin:0 0 6px 0; font-size:14px; color:#445; }
    .metric .value { font-size:20px; font-weight:800; }

    .project-card { border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow); background:#fff; max-width:380px; }
    .project-card h4 { margin:0; font-size:15px; font-weight:800; }
    .small { color:var(--muted); font-size:12px; }

    /* Tabs bottom navbar */
    nav.tabs { position:fixed; bottom:0; left:0; right:0; border-top:1px solid var(--border); background:#fff; display:grid; grid-template-columns: repeat(4, 1fr); }
    nav.tabs a { text-decoration:none; color:#444; font-size:12px; text-align:center; padding:10px 0; }
    nav.tabs a.active { color:var(--primary); font-weight:700; }
    .tab-icon { display:block; font-size:18px; }

    .hidden { display:none; }
    input[type="search"], input[type="text"], input[type="date"], input[type="number"], textarea, select { width:100%; padding:8px; border:1px solid var(--border); border-radius:8px; }

    /* Modals */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; }
    .modal.show { display:flex; }
    .panel { background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.25); width:760px; max-width:95vw; }
    .panel header { padding:10px 14px; background:#f5f7ff; border-radius:12px 12px 0 0; font-weight:700; }
    .panel .body { padding:14px; max-height:70vh; overflow:auto; }
    .panel .footer { padding:10px 14px; display:flex; justify-content:flex-end; gap:8px; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px; }

    .role-pill { margin-left:6px; }
    .muted { color:var(--muted); }
  </style>
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <header class="appbar">
    <div class="brand">Work Order Linked Cost Allocation Standings</div>
    <div class="company">
      <img id="company-logo" alt="Company" />
      <span id="company-name" class="muted">Company</span>
      <span id="user-info" class="pill">Not signed in</span>
      <button class="btn" onclick="signIn()">Sign in</button>
      <button class="btn secondary" onclick="signOut()">Sign out</button>
    </div>
  </header>

  <div class="container">
    <!-- HOME -->
    <section id="home" class="tab">
      <div class="card hero">
        <h1>Welcome to Work Order Linked Cost Allocation Standings</h1>
        <p>Create and track work orders, tasks, allocations, photos, and reports ‚Äî all offline in one file.</p>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button class="btn" onclick="openTaskModal()">New Order</button>
          <button class="btn secondary" onclick="goTab('projects')">View Projects</button>
        </div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px 0;">Recent projects</h3>
        <div id="recent-projects"></div>
      </div>
    </section>

    <!-- PROJECTS -->
    <section id="projects" class="tab hidden">
      <div class="card">
        <h3 style="margin:0 0 8px 0;">Projects</h3>
        <label class="small">Search</label>
        <input id="project-search" type="search" placeholder="Search by address or description" />
        <div id="project-list" style="margin-top:10px;"></div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="tab hidden">
      <div class="card">
        <h3>Dashboard <span class="pill role-pill" id="role-label">viewer</span></h3>
        <div class="grid" style="margin-top:10px;">
          <div class="card metric"><h3>Total Projects</h3><div class="value" id="metric-projects">‚Äî</div></div>
          <div class="card metric"><h3>Active Projects</h3><div class="value" id="metric-active">‚Äî</div></div>
          <div class="card metric"><h3>Completed Projects</h3><div class="value" id="metric-completed">‚Äî</div></div>
          <div class="card metric"><h3>Total Costs (tasks)</h3><div class="value" id="metric-totalcost">‚Äî</div></div>
          <div class="card metric"><h3>Total Sales (expected)</h3><div class="value" id="metric-sales">‚Äî</div></div>
        </div>
        <div class="card" style="margin-top:12px;">
          <h3 style="margin:0 0 8px 0;">Recent Activity</h3>
          <ul id="recent-activity" class="small"></ul>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="tab hidden">
      <div class="card">
        <h3>Settings</h3>
        <div class="form-row">
          <div>
            <label>Company name</label>
            <input id="set-company-name" type="text" placeholder="Company" />
          </div>
          <div>
            <label>Logo</label>
            <input id="set-logo" type="file" accept="image/*" />
          </div>
        </div>
        <button class="btn" onclick="saveSettings()">Save</button>
      </div>
    </section>

    <!-- TASK MODAL -->
    <div id="task-modal" class="modal">
      <div class="panel">
        <header><h3 id="task-modal-title">Edit Task</h3></header>
        <div class="body">
          <div class="form-row"><div><label>Title</label><input id="t_title"/></div><div><label>Address</label><input id="t_address"/></div></div>
          <div class="form-row"><div><label>Start Date</label><input id="t_start" type="date"/></div><div><label>End Date</label><input id="t_end" type="date"/></div></div>
          <div class="form-row"><div><label>Quantity</label><input id="t_qty" type="number" step="0.01"/></div><div><label>Unit Cost</label><input id="t_uc" type="number" step="0.01"/></div></div>
          <div class="form-row"><div><label>Total Cost</label><input id="t_tc" type="number" step="0.01"/></div><div><label>Allocation</label><input id="t_alloc" type="number" step="0.01"/></div></div>
          <div class="form-row"><div><label>Sprint</label><input id="t_sprint"/></div><div><label>Assignee</label><input id="t_assign"/></div></div>
          <div class="form-row"><div><label>Description</label><textarea id="t_desc"></textarea></div><div><label>Notes</label><textarea id="t_notes"></textarea></div></div>
          <div class="form-row"><div><label>Photo (optional)</label><input id="t_photo" type="file" accept="image/*"/></div><div><small>Uploaded photo URL saved to "Photos".</small></div></div>
        </div>
        <div class="footer">
          <button id="btn-task-delete" class="btn danger">Delete</button>
          <button class="btn secondary" onclick="closeTaskModal()">Cancel</button>
          <button id="btn-task-save" class="btn">Save</button>
        </div>
      </div>
    </div>

    <!-- PROJECT MODAL -->
    <div id="project-modal" class="modal">
      <div class="panel">
        <header><h3 id="project-modal-title">Edit Project</h3></header>
        <div class="body">
          <div class="form-row"><div><label>Title</label><input id="p_title"/></div><div><label>Owner</label><input id="p_owner"/></div></div>
          <div class="form-row"><div><label>Start Date</label><input id="p_start" type="date"/></div><div><label>Expected Sales</label><input id="p_sales" type="number" step="0.01"/></div></div>
          <div class="form-row"><div><label>Active</label><select id="p_active"><option value="true">Yes</option><option value="false">No</option></select></div></div>
        </div>
        <div class="footer">
          <button id="btn-project-delete" class="btn danger">Delete</button>
          <button class="btn secondary" onclick="closeProjectModal()">Cancel</button>
          <button id="btn-project-save" class="btn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom tabs -->
  <nav class="tabs">
    <a id="tab-home" href="javascript:goTab('home')" class="active"><span class="tab-icon">üè†</span>Home</a>
    <a id="tab-projects" href="javascript:goTab('projects')"><span class="tab-icon">üìÅ</span>Projects</a>
    <a id="tab-dashboard" href="javascript:goTab('dashboard')"><span class="tab-icon">üìä</span>Dashboard</a>
    <a id="tab-settings" href="javascript:goTab('settings')"><span class="tab-icon">‚öôÔ∏è</span>Settings</a>
  </nav>

<script>
const CONFIG = {
  msal: { clientId: "827656f8-3a21-4d69-b6e5-c35e2ec2fb71", authority: "https://login.microsoftonline.com/97d84781-b85c-4034-a0d0-588e7b442e45", redirectUri: "https://abirrahat.github.io/wolcas-webapp/auth" },
  graphScopes: ["User.Read","Sites.ReadWrite.All","Files.ReadWrite.All","Group.Read.All"],
  sharepoint: { host: "architektica-my.sharepoint.com", sitePath: "/personal/abir_architektica_com", taskListName: "Task", projectListName: "Project" },
  photos: { folder: "TaskPhotos" }, appRoot: "https://abirrahat.github.io/wolcas-webapp/"
};

const COLUMN_MAP = {
  Task: {
    Title:"Title", Address:"Address", StartDate:"Start_x0020_Date", EndDate:"End_x0020_Date",
    Quantity:"Quantity", UnitCost:"Unit_x0020_Cost", TotalCost:"Total_x0020_Cost", Allocation:"Allocation",
    Sprint:"Sprint", Assignee:"Assignee", Description:"Description", Notes:"Notes", Photos:"Photos"
  },
  Project: {
    Title:"Title", Owner:"Owner", StartDate:"Start_x0020_Date", ExpectedSales:"Expected_x0020_Sales", Active:"Active"
  }
};

function goTab(id) {
  document.querySelectorAll('.tab').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('nav.tabs a').forEach(a=>a.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
}

(function initSettings(){
  const name = localStorage.getItem('wolcas.companyName')||'Company';
  document.getElementById('company-name').textContent = name;
  document.getElementById('set-company-name').value = name;
  const logo = localStorage.getItem('wolcas.companyLogo');
  if (logo) document.getElementById('company-logo').src = logo;
})();

function saveSettings(){
  const name = document.getElementById('set-company-name').value||'Company';
  localStorage.setItem('wolcas.companyName', name);
  document.getElementById('company-name').textContent = name;
  const file = document.getElementById('set-logo').files?.[0];
  if (file){
    const reader = new FileReader();
    reader.onload = () => { localStorage.setItem('wolcas.companyLogo', reader.result); document.getElementById('company-logo').src = reader.result; };
    reader.readAsDataURL(file);
  }
  alert('Saved');
}

const msalInstance = new msal.PublicClientApplication({ auth: CONFIG.msal, cache: { cacheLocation:'localStorage' } });
let ACTIVE_ACCOUNT=null; let ROLE='viewer';

msalInstance.handleRedirectPromise().then(resp=>{
  if (resp) msalInstance.setActiveAccount(resp.account);
  const acc = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];
  if (acc) { msalInstance.setActiveAccount(acc); ACTIVE_ACCOUNT = acc; document.getElementById('user-info').textContent = acc.username; initSharePoint(); }
}).catch(console.error);

async function signIn(){ await msalInstance.loginRedirect({ scopes: CONFIG.graphScopes }); }
function signOut(){ msalInstance.logoutRedirect(); }

async function getToken(){
  const acc = msalInstance.getActiveAccount(); if(!acc) throw new Error('No active account');
  try{ const r = await msalInstance.acquireTokenSilent({ scopes: CONFIG.graphScopes, account: acc }); return r.accessToken; }
  catch(e){ await msalInstance.acquireTokenRedirect({ scopes: CONFIG.graphScopes }); }
}
async function graphGET(url){ const t=await getToken(); const r=await fetch(url,{headers:{Authorization:`Bearer ${t}`}}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function graphPOST(url,body){ const t=await getToken(); const r=await fetch(url,{method:'POST',headers:{Authorization:`Bearer ${t}`,'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function graphPATCH(url,body){ const t=await getToken(); const r=await fetch(url,{method:'PATCH',headers:{Authorization:`Bearer ${t}`,'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function graphDELETE(url){ const t=await getToken(); const r=await fetch(url,{method:'DELETE',headers:{Authorization:`Bearer ${t}`}}); if(!r.ok) throw new Error(await r.text()); return true; }

let SITE_ID=null, TASK_LIST_ID=null, PROJECT_LIST_ID=null, DEFAULT_DRIVE_ID=null; let PROJECTS=[], TASKS=[];

async function initSharePoint(){
  await resolveRole();
  const site = await graphGET(`https://graph.microsoft.com/v1.0/sites/${CONFIG.sharepoint.host}:${CONFIG.sharepoint.sitePath}`); SITE_ID=site.id;
  const lists = await graphGET(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists`);
  const task = lists.value.find(l=>l.displayName===CONFIG.sharepoint.taskListName);
  const project = lists.value.find(l=>l.displayName===CONFIG.sharepoint.projectListName);
  TASK_LIST_ID=task?.id; PROJECT_LIST_ID=project?.id; if(!TASK_LIST_ID||!PROJECT_LIST_ID){ alert('Task/Project lists not found.'); return; }
  const drive = await graphGET(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/drive`); DEFAULT_DRIVE_ID=drive.id; await ensurePhotoFolder(CONFIG.photos.folder);
  await refreshAll();
}

async function resolveRole(){
  try{ const groups=await graphGET('https://graph.microsoft.com/v1.0/me/memberOf?$select=displayName'); const names=(groups.value||[]).map(g=>g.displayName||''); ROLE = names.includes('WOLCAS-Admins')? 'admin' : names.includes('WOLCAS-Editors')? 'editor' : 'viewer'; }catch(e){ ROLE='viewer'; }
  document.getElementById('role-label').textContent = ROLE;
}
function canEdit(){ return ROLE==='admin'||ROLE==='editor'; }

async function loadProjects(){ const r=await graphGET(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists/${PROJECT_LIST_ID}/items?expand=fields`); PROJECTS=r.value.map(i=>({ id:i.id, title:i.fields[COLUMN_MAP.Project.Title], owner:i.fields[COLUMN_MAP.Project.Owner], startDate:i.fields[COLUMN_MAP.Project.StartDate], expectedSales:Number(i.fields[COLUMN_MAP.Project.ExpectedSales]||0), active:!!i.fields[COLUMN_MAP.Project.Active] })); }
async function loadTasks(){ const r=await graphGET(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists/${TASK_LIST_ID}/items?expand=fields`); TASKS=r.value.map(i=>({ id:i.id, title:i.fields[COLUMN_MAP.Task.Title], address:i.fields[COLUMN_MAP.Task.Address], startDate:i.fields[COLUMN_MAP.Task.StartDate], endDate:i.fields[COLUMN_MAP.Task.EndDate], quantity:Number(i.fields[COLUMN_MAP.Task.Quantity]||0), unitCost:Number(i.fields[COLUMN_MAP.Task.UnitCost]||0), totalCost:Number(i.fields[COLUMN_MAP.Task.TotalCost]||0), allocation:Number(i.fields[COLUMN_MAP.Task.Allocation]||0), sprint:i.fields[COLUMN_MAP.Task.Sprint], assignee:i.fields[COLUMN_MAP.Task.Assignee], description:i.fields[COLUMN_MAP.Task.Description], notes:i.fields[COLUMN_MAP.Task.Notes], photos:i.fields[COLUMN_MAP.Task.Photos] })); }

function updateDashboard(){ const totalProjects=PROJECTS.length; const active=PROJECTS.filter(p=>p.active).length; const completed=PROJECTS.filter(p=>!p.active).length; const totalCost=TASKS.reduce((s,t)=>s+(Number(t.totalCost)||0),0); const sales=PROJECTS.reduce((s,p)=>s+(Number(p.expectedSales)||0),0); document.getElementById('metric-projects').textContent=totalProjects; document.getElementById('metric-active').textContent=active; document.getElementById('metric-completed').textContent=completed; document.getElementById('metric-totalcost').textContent=totalCost.toFixed(2); document.getElementById('metric-sales').textContent=sales.toFixed(2); }

async function refreshAll(){ await loadProjects(); await loadTasks(); renderRecentProjects(); renderProjectsList(); updateDashboard(); await renderRecentActivity(); }

function renderRecentProjects(){ const cont=document.getElementById('recent-projects'); cont.innerHTML=''; PROJECTS.slice(0,3).forEach(p=>{ cont.appendChild(projectCard(p,true)); }); }

function renderProjectsList(){ const cont=document.getElementById('project-list'); cont.innerHTML=''; const q=(document.getElementById('project-search').value||'').toLowerCase(); PROJECTS.filter(p=>!q|| (p.title||'').toLowerCase().includes(q) || (p.owner||'').toLowerCase().includes(q)).forEach(p=>{ cont.appendChild(projectCard(p,false)); }); }

document.getElementById('project-search').addEventListener('input', renderProjectsList);

function projectCard(p,compact){ const wrap=document.createElement('div'); wrap.className='project-card'; const status = p.active? '<span class="pill success">active</span>' : '<span class="pill">completed</span>'; const start=(p.startDate||'').substring(0,10); const expected=p.expectedSales.toFixed(2); const totalCost = sumProjectCostApprox(p); wrap.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;"><h4>${p.title||''}</h4>${status}</div><div class="small">Owner: ${p.owner||''}</div><div class="small" style="margin:6px 0;">Expected sales: ${expected} &nbsp;&nbsp; Start: ${start}</div><div class="small">Total cost: ${totalCost.toFixed(2)}</div><div style="margin-top:8px; display:flex; gap:6px;">${canEdit()? `<button class='btn secondary' onclick='openProjectModal("${p.id}")'>Edit</button>`:''}${ROLE==='admin'? `<button class='btn danger' onclick='deleteProject("${p.id}")'>Delete</button>`:''}<button class='btn' onclick='goTab("dashboard")'>Open</button>${p.active? `<button class='btn ghost' onclick='markProjectActive("${p.id}", false)'>Mark Complete</button>`:`<button class='btn ghost' onclick='markProjectActive("${p.id}", true)'>Mark Active</button>`}</div>`; return wrap; }

function sumProjectCostApprox(p){ const key=(p.title||'').toLowerCase(); return TASKS.filter(t=> (t.address||'').toLowerCase().includes(key) ).reduce((s,t)=>s+(Number(t.totalCost)||0),0); }

async function markProjectActive(id,isActive){ const fields={}; fields[COLUMN_MAP.Project.Active]=isActive; const before=PROJECTS.find(x=>x.id===id); await graphPATCH(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists/${PROJECT_LIST_ID}/items/${id}`,{fields}); await logAudit(isActive?'mark-active':'mark-complete','Project',id,before,fields); await refreshAll(); }

let editingProjectId=null, editingTaskId=null;
function openProjectModal(id){ if(!canEdit()) return alert('No permission'); editingProjectId=id||null; const p=PROJECTS.find(x=>x.id===id)||{ title:'',owner:'',startDate:'',expectedSales:0,active:true }; document.getElementById('project-modal-title').textContent=id? 'Edit Project':'New Project'; document.getElementById('p_title').value=p.title||''; document.getElementById('p_owner').value=p.owner||''; document.getElementById('p_start').value=(p.startDate||'').substring(0,10); document.getElementById('p_sales').value=p.expectedSales||0; document.getElementById('p_active').value=p.active? 'true':'false'; document.getElementById('btn-project-delete').style.display=(ROLE==='admin'&&id)?'inline-block':'none'; document.getElementById('project-modal').classList.add('show'); }
function closeProjectModal(){ document.getElementById('project-modal').classList.remove('show'); }

function openTaskModal(id){ if(!canEdit()) return alert('No permission'); editingTaskId=id||null; const t=TASKS.find(x=>x.id===id)||{ title:'',address:'',startDate:'',endDate:'',quantity:0,unitCost:0,totalCost:0,allocation:0,sprint:'',assignee:'',description:'',notes:'' }; document.getElementById('task-modal-title').textContent=id? 'Edit Task':'New Task'; document.getElementById('t_title').value=t.title||''; document.getElementById('t_address').value=t.address||''; document.getElementById('t_start').value=(t.startDate||'').substring(0,10); document.getElementById('t_end').value=(t.endDate||'').substring(0,10); document.getElementById('t_qty').value=t.quantity||0; document.getElementById('t_uc').value=t.unitCost||0; document.getElementById('t_tc').value=t.totalCost||0; document.getElementById('t_alloc').value=t.allocation||0; document.getElementById('t_sprint').value=t.sprint||''; document.getElementById('t_assign').value=t.assignee||''; document.getElementById('t_desc').value=t.description||''; document.getElementById('t_notes').value=t.notes||''; document.getElementById('t_photo').value=''; document.getElementById('btn-task-delete').style.display=(ROLE==='admin'&&id)?'inline-block':'none'; document.getElementById('task-modal').classList.add('show'); }
function closeTaskModal(){ document.getElementById('task-modal').classList.remove('show'); }

['t_qty','t_uc'].forEach(id=>{ document.addEventListener('input',e=>{ if(e.target&&e.target.id===id){ const q=Number(document.getElementById('t_qty').value||0); const u=Number(document.getElementById('t_uc').value||0); document.getElementById('t_tc').value=(q*u).toFixed(2); } }); });

document.getElementById('btn-project-save').addEventListener('click', async ()=>{ if(!canEdit()) return alert('No permission'); const f={}; f[COLUMN_MAP.Project.Title]=document.getElementById('p_title').value; f[COLUMN_MAP.Project.Owner]=document.getElementById('p_owner').value; f[COLUMN_MAP.Project.StartDate]=document.getElementById('p_start').value; f[COLUMN_MAP.Project.ExpectedSales]=Number(document.getElementById('p_sales').value||0); f[COLUMN_MAP.Project.Active]=document.getElementById('p_active').value==='true'; if(editingProjectId){ const before=PROJECTS.find(x=>x.id===editingProjectId); await graphPATCH(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists/${PROJECT_LIST_ID}/items/${editingProjectId}`,{fields:f}); await logAudit('update','Project',editingProjectId,before,f); } else { const res=await graphPOST(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists/${PROJECT_LIST_ID}/items`,{fields:f}); await logAudit('create','Project',res.id,null,f); } closeProjectModal(); await refreshAll(); });

document.getElementById('btn-project-delete').addEventListener('click', async ()=>{ if(ROLE!=='admin') return alert('Only admins can delete projects'); if(!editingProjectId) return; if(!confirm('Delete this project?')) return; const before=PROJECTS.find(x=>x.id===editingProjectId); await graphDELETE(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists/${PROJECT_LIST_ID}/items/${editingProjectId}`); await logAudit('delete','Project',editingProjectId,before,null); closeProjectModal(); await refreshAll(); });

document.getElementById('btn-task-save').addEventListener('click', async ()=>{ if(!canEdit()) return alert('No permission'); const f={}; f[COLUMN_MAP.Task.Title]=document.getElementById('t_title').value; f[COLUMN_MAP.Task.Address]=document.getElementById('t_address').value; f[COLUMN_MAP.Task.StartDate]=document.getElementById('t_start').value; f[COLUMN_MAP.Task.EndDate]=document.getElementById('t_end').value; f[COLUMN_MAP.Task.Quantity]=Number(document.getElementById('t_qty').value||0); f[COLUMN_MAP.Task.UnitCost]=Number(document.getElementById('t_uc').value||0); f[COLUMN_MAP.Task.TotalCost]=Number(document.getElementById('t_tc').value||0); f[COLUMN_MAP.Task.Allocation]=Number(document.getElementById('t_alloc').value||0); f[COLUMN_MAP.Task.Sprint]=document.getElementById('t_sprint').value; f[COLUMN_MAP.Task.Assignee]=document.getElementById('t_assign').value; f[COLUMN_MAP.Task.Description]=document.getElementById('t_desc').value; f[COLUMN_MAP.Task.Notes]=document.getElementById('t_notes').value; const file=document.getElementById('t_photo').files?.[0]; if(file){ const url=await uploadPhoto(file); if(url) f[COLUMN_MAP.Task.Photos]=url; } if(editingTaskId){ const before=TASKS.find(x=>x.id===editingTaskId); await graphPATCH(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists/${TASK_LIST_ID}/items/${editingTaskId}`,{fields:f}); await logAudit('update','Task',editingTaskId,before,f); } else { const res=await graphPOST(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists/${TASK_LIST_ID}/items`,{fields:f}); await logAudit('create','Task',res.id,null,f); } closeTaskModal(); await refreshAll(); });

document.getElementById('btn-task-delete').addEventListener('click', async ()=>{ if(ROLE!=='admin') return alert('Only admins can delete tasks'); if(!editingTaskId) return; if(!confirm('Delete this task?')) return; const before=TASKS.find(x=>x.id===editingTaskId); await graphDELETE(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists/${TASK_LIST_ID}/items/${editingTaskId}`); await logAudit('delete','Task',editingTaskId,before,null); closeTaskModal(); await refreshAll(); });

async function ensurePhotoFolder(folder){ try{ await graphPOST(`https://graph.microsoft.com/v1.0/drives/${DEFAULT_DRIVE_ID}/root/children`,{ name:folder, folder:{}, "@microsoft.graph.conflictBehavior":"replace" }); }catch(e){} }
async function uploadPhoto(file){ const safe=file.name.replace(/[^a-zA-Z0-9._-]/g,'_'); const url=`https://graph.microsoft.com/v1.0/drives/${DEFAULT_DRIVE_ID}/root:/${CONFIG.photos.folder}/${safe}:/content`; const t=await getToken(); const r=await fetch(url,{method:'PUT', headers:{Authorization:`Bearer ${t}`,'Content-Type':file.type||'application/octet-stream'}, body:file}); if(!r.ok){ alert('Photo upload failed'); return null; } const item=await r.json(); return item.webUrl||null; }

async function logAudit(action,itemType,itemId,before,after){ try{ const details={ by:ACTIVE_ACCOUNT?.username, when:new Date().toISOString(), action, itemType, itemId, before, after }; const lists=await graphGET(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists`); let audit=lists.value.find(l=>l.displayName==='Audit'); if(!audit) audit=await graphPOST(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists`,{ displayName:'Audit', list:{ template:'genericList' } }); const AUDIT_ID=audit.id||audit.value?.id; await graphPOST(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists/${AUDIT_ID}/items`,{ fields:{ Title: `${action} ${itemType}`, Details: JSON.stringify(details,null,2) } }); }catch(e){ console.warn('Audit failed',e); } }

async function renderRecentActivity(){ try{ const lists=await graphGET(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists`); const audit=lists.value.find(l=>l.displayName==='Audit'); if(!audit) return; const items=await graphGET(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists/${audit.id}/items?expand=fields&$orderby=createdDateTime desc&$top=10`); const ul=document.getElementById('recent-activity'); ul.innerHTML=''; (items.value||[]).forEach(i=>{ const li=document.createElement('li'); li.textContent = `${new Date(i.createdDateTime).toLocaleString()} ‚Äî ${i.fields.Title}`; ul.appendChild(li); }); }catch(e){ console.warn('Activity load failed',e); } }

goTab('home');
</script>
</body>
</html>
