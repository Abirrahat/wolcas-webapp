<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WOLCAS</title>
  <!-- CSP: allow local inline scripts, Graph & AAD auth calls, and Wikimedia logo images -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://upload.wikimedia.org; connect-src 'self' https://graph.microsoft.com https://login.microsoftonline.com; frame-src 'self' https://login.microsoftonline.com; font-src 'self' data:; object-src 'none'; base-uri 'self'; form-action 'self' https://login.microsoftonline.com;" />
  <style>
    :root { --accent:#2563eb; --bg:#ffffff; --muted:#6b7280; --danger:#b91c1c; }
    html,body { height:100%; background:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    header { display:flex; align-items:center; gap:12px; padding:12px 16px; border-bottom:1px solid #e5e7eb; }
    header .logo { height:56px; width:auto; }
    header h1 { font-size:20px; margin:0; letter-spacing:0.3px; }
    header nav { margin-left:auto; display:flex; align-items:center; gap:12px; }
    .btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; background:#fff; cursor:pointer; }
    .btn.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    .btn.danger { background:var(--danger); color:#fff; border-color:var(--danger); }
    .badge { padding:2px 8px; background:#eef2ff; color:#4338ca; border-radius:999px; font-size:12px; }
    #signInCard { max-width:420px; margin:64px auto; padding:24px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    #signInCard h2 { margin:0 0 8px; }
    #signInCard p { margin:0 0 16px; color:var(--muted); }
    #appRoot { display:none; }
    main { padding:16px; }
    /* Layout placeholders preserved from original offline app (Projects/Dashboard/Settings/Tabs) */
    .tabs { display:flex; gap:12px; border-bottom:1px solid #e5e7eb; margin-bottom:16px; }
    .tab { padding:8px 12px; border-radius:8px 8px 0 0; cursor:pointer; }
    .tab.active { background:#f3f4f6; }
    .grid { display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width:900px){ .grid{ grid-template-columns: 2fr 1fr; } }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #e5e7eb; padding:8px; text-align:left; }
    .actions { display:flex; gap:8px; }
    .hidden { display:none !important; }
    .field { display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter:blur(2px); background:rgba(0,0,0,.35); }
    .modal .panel { width:min(720px, 92vw); max-height:85vh; overflow:auto; background:#fff; border-radius:12px; padding:16px; }
  </style>
</head>
<body>
  <header>
    <img class="logo" alt="Logo" src="https://upload.wikimedia.org/wikipedia/commons/5/59/Construction_icon.svg" />
    <h1>WOLCAS</h1>
    <nav>
      <span id="userEmail" class="badge hidden"></span>
      <button id="signInBtn" class="btn primary">Sign in</button>
      <button id="signOutBtn" class="btn danger hidden">Sign out</button>
    </nav>
  </header>

  <!-- Sign-in only card (white background) -->
  <section id="signInCard">
    <h2>Sign in to continue</h2>
    <p>Only permitted users in your company can access this app.</p>
    <button id="cardSignInBtn" class="btn primary">Sign in with Microsoft</button>
  </section>

  <!-- App content is hidden until auth succeeds. Layout preserved. -->
  <div id="appRoot">
    <main>
      <div class="tabs">
        <div class="tab active" data-tab="projects">üèóÔ∏è Projects</div>
        <div class="tab" data-tab="tasks">üìù Tasks</div>
        <div class="tab" data-tab="dashboard">üìä Dashboard</div>
        <div class="tab" data-tab="settings">‚öôÔ∏è Settings</div>
      </div>

      <!-- Projects -->
      <section id="tab-projects">
        <div class="actions" style="justify-content:flex-end; margin-bottom:8px;">
          <button id="btnAddProject" class="btn hidden">Add Project</button>
        </div>
        <div class="grid">
          <div>
            <table id="projectTable">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Project Address</th>
                  <th>Owner</th>
                  <th>Start Date</th>
                  <th>Expected Sales</th>
                  <th>Active</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <aside>
            <div class="field"><label>Title</label><input id="projTitle" /></div>
            <div class="field"><label>Project Address</label><input id="projAddress" /></div>
            <div class="field"><label>Owner</label><input id="projOwner" /></div>
            <div class="field"><label>Start Date</label><input id="projStart" type="date" /></div>
            <div class="field"><label>Expected Sales</label><input id="projSales" type="number" step="0.01" /></div>
            <div class="field"><label><input id="projActive" type="checkbox" /> Active</label></div>
            <div class="actions">
              <button id="projSave" class="btn">Save</button>
              <button id="projDelete" class="btn danger hidden">Delete</button>
            </div>
          </aside>
        </div>
      </section>

      <!-- Tasks -->
      <section id="tab-tasks" class="hidden">
        <div class="actions" style="justify-content:flex-end; margin-bottom:8px;">
          <button id="btnAddTask" class="btn hidden">Add Task</button>
        </div>
        <table id="taskTable">
          <thead>
            <tr>
              <th>Task name</th>
              <th>Address</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Quantity</th>
              <th>Unit Cost</th>
              <th>Total Cost</th>
              <th>Allocation</th>
              <th>Sprint</th>
              <th>Assignee</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Dashboard -->
      <section id="tab-dashboard" class="hidden">
        <div class="grid">
          <div>
            <h3>Totals</h3>
            <ul id="dashboardTotals"></ul>
          </div>
          <div>
            <h3>Recent Activity</h3>
            <ul id="recentActivity"></ul>
          </div>
        </div>
      </section>

      <!-- Settings -->
      <section id="tab-settings" class="hidden">
        <div class="field"><label>Company name</label><input id="companyName" /></div>
        <div class="field"><label>Logo URL</label><input id="companyLogo" /></div>
        <div class="actions"><button id="settingsSave" class="btn">Save</button></div>
      </section>
    </main>

    <!-- Task Editor Modal -->
    <div id="taskModal" class="modal">
      <div class="panel">
        <h3>Edit Task</h3>
        <div class="grid" style="grid-template-columns:1fr 1fr;">
          <div class="field"><label>Title</label><input id="taskTitle" /></div>
          <div class="field"><label>Address</label><input id="taskAddress" /></div>
          <div class="field"><label>Start Date</label><input id="taskStart" type="date" /></div>
          <div class="field"><label>End Date</label><input id="taskEnd" type="date" /></div>
          <div class="field"><label>Quantity</label><input id="taskQty" type="number" step="0.01" /></div>
          <div class="field"><label>Unit Cost</label><input id="taskUnitCost" type="number" step="0.01" /></div>
          <div class="field"><label>Total Cost</label><input id="taskTotalCost" type="number" step="0.01" /></div>
          <div class="field"><label>Allocation</label><input id="taskAllocation" type="number" step="0.01" /></div>
          <div class="field"><label>Sprint</label><input id="taskSprint" /></div>
          <div class="field"><label>Assignee</label><input id="taskAssignee" /></div>
        </div>
        <div class="field"><label>Description</label><textarea id="taskDesc"></textarea></div>
        <div class="field"><label>Notes</label><textarea id="taskNotes"></textarea></div>
        <div class="field"><label>Photos</label><input id="taskPhotos" type="file" accept="image/*" multiple /></div>
        <div class="actions">
          <button id="taskSave" class="btn">Save</button>
          <button id="taskDelete" class="btn danger hidden">Delete</button>
          <button id="taskClose" class="btn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Local MSAL (no external CDNs) -->
  <script src="./msal-browser.min.js"></script>
  <script>
    // === MSAL configuration ===
    const msalConfig = {
      auth: {
        clientId: '827656f8-3a21-4d69-b6e5-c35e2ec2fb71',
        authority: 'https://login.microsoftonline.com/97d84781-b85c-4034-a0d0-588e7b442e45',
        redirectUri: 'https://abirrahat.github.io/wolcas-webapp/auth',
        navigateToLoginRequestUrl: false
      },
      cache: { cacheLocation: 'sessionStorage', storeAuthStateInCookie: false },
      system: { allowRedirectInIframe: false }
    };
    const loginRequest = {
      scopes: ['User.Read','Sites.ReadWrite.All','Files.ReadWrite.All','Group.Read.All'],
      prompt: 'select_account'
    };
    const graphScopes = loginRequest.scopes;
    const msalInstance = new msal.PublicClientApplication(msalConfig);
    let account = null; // active account
    let ROLE = 'viewer'; // default

    // Utility Graph call
    async function graphGET(path) {
      const token = await getToken();
      const resp = await fetch('https://graph.microsoft.com/v1.0' + path, {
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type':'application/json' }
      });
      if (!resp.ok) throw new Error('Graph GET failed: ' + resp.status);
      return await resp.json();
    }
    async function graphPOST(path, body) {
      const token = await getToken();
      const resp = await fetch('https://graph.microsoft.com/v1.0' + path, {
        method:'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type':'application/json' }, body: JSON.stringify(body)
      });
      if (!resp.ok) throw new Error('Graph POST failed: ' + resp.status);
      return await resp.json();
    }
    async function graphPATCH(path, body) {
      const token = await getToken();
      const resp = await fetch('https://graph.microsoft.com/v1.0' + path, {
        method:'PATCH', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type':'application/json' }, body: JSON.stringify(body)
      });
      if (!resp.ok) throw new Error('Graph PATCH failed: ' + resp.status);
      return await resp.json();
    }
    async function graphDELETE(path) {
      const token = await getToken();
      const resp = await fetch('https://graph.microsoft.com/v1.0' + path, {
        method:'DELETE', headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!resp.ok) throw new Error('Graph DELETE failed: ' + resp.status);
      return true;
    }

    async function getToken() {
      const active = msalInstance.getActiveAccount() || account;
      if (!active) throw new Error('No active account');
      try {
        const resp = await msalInstance.acquireTokenSilent({ account: active, scopes: graphScopes });
        return resp.accessToken;
      } catch (e) {
        const resp = await msalInstance.acquireTokenPopup(loginRequest);
        return resp.accessToken;
      }
    }

    // RBAC via groups (optional): map to Admin/Editor/Viewer
    async function resolveRole() {
      try {
        const me = await graphGET('/me');
        const groups = await graphGET('/me/transitiveMemberOf?$select=displayName');
        const names = (groups.value||[]).map(g=>g.displayName||'');
        if (names.some(n=>n.toLowerCase().includes('wolcas') && n.toLowerCase().includes('admin'))) ROLE='admin';
        else if (names.some(n=>n.toLowerCase().includes('wolcas') && n.toLowerCase().includes('editor'))) ROLE='editor';
        else ROLE='viewer';
      } catch(err) { ROLE='viewer'; }
      applyRoleUI();
    }
    function applyRoleUI(){
      // Per spec: Admin can delete & change Allocation; Editor can edit; Viewer read-only
      document.getElementById('btnAddProject').classList.toggle('hidden', ROLE==='viewer');
      document.getElementById('btnAddTask').classList.toggle('hidden', ROLE==='viewer');
      document.getElementById('projDelete').classList.toggle('hidden', ROLE!=='admin');
      document.getElementById('taskDelete').classList.toggle('hidden', ROLE!=='admin');
      // Allocation field: editable only if admin
      document.getElementById('taskAllocation').disabled = (ROLE!=='admin');
    }

    // SharePoint list wiring
    const SP_HOST = 'architektica-my.sharepoint.com';
    const SP_PATH = '/personal/abir_architektica_com'; // site path
    let spSiteId = null, projectListId = null, taskListId = null;

    async function resolveSharePointIds(){
      const site = await graphGET(`/sites/${SP_HOST}:${SP_PATH}`);
      spSiteId = site.id;
      const lists = await graphGET(`/sites/${spSiteId}/lists?$select=id,displayName`);
      for (const l of lists.value){
        if (l.displayName === 'Project') projectListId = l.id;
        if (l.displayName === 'Task') taskListId = l.id;
      }
    }

    async function loadProjectsTop8(){
      const items = await graphGET(`/sites/${spSiteId}/lists/${projectListId}/items?$top=8&$expand=fields`);
      const tbody = document.querySelector('#projectTable tbody');
      tbody.innerHTML='';
      (items.value||[]).forEach(it=>{
        const f = it.fields||{};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.Title||''}</td>
          <td>${f['Project Address']||''}</td>
          <td>${f.Owner||''}</td>
          <td>${f['Start Date']||''}</td>
          <td>${f['Expected Sales']||''}</td>
          <td>${f.Active? '‚úîÔ∏è':''}</td>
          <td class="actions">
            <button class="btn btn-sm ${ROLE==='viewer'?'hidden':''}" data-edit="${it.id}">Edit</button>
            <button class="btn danger btn-sm ${ROLE==='admin'?'':'hidden'}" data-del="${it.id}">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
      // Row actions
      tbody.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.addEventListener('click', ()=>editProject(btn.getAttribute('data-edit')));
      });
      tbody.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=>deleteProject(btn.getAttribute('data-del')));
      });
    }

    async function editProject(itemId){
      const item = await graphGET(`/sites/${spSiteId}/lists/${projectListId}/items/${itemId}?$expand=fields`);
      const f = item.fields||{};
      document.getElementById('projTitle').value = f.Title||'';
      document.getElementById('projAddress').value = f['Project Address']||'';
      document.getElementById('projOwner').value = f.Owner||'';
      document.getElementById('projStart').value = (f['Start Date']||'');
      document.getElementById('projSales').value = f['Expected Sales']||'';
      document.getElementById('projActive').checked = !!f.Active;
      document.getElementById('projSave').onclick = ()=>saveProject(itemId);
      document.getElementById('projDelete').onclick = ()=>deleteProject(itemId);
      document.getElementById('projDelete').classList.toggle('hidden', ROLE!=='admin');
    }
    async function saveProject(itemId){
      const fields = {
        Title: document.getElementById('projTitle').value,
        'Project Address': document.getElementById('projAddress').value,
        Owner: document.getElementById('projOwner').value,
        'Start Date': document.getElementById('projStart').value,
        'Expected Sales': parseFloat(document.getElementById('projSales').value||'0'),
        Active: document.getElementById('projActive').checked
      };
      if (itemId){
        await graphPATCH(`/sites/${spSiteId}/lists/${projectListId}/items/${itemId}/fields`, fields);
      } else {
        await graphPOST(`/sites/${spSiteId}/lists/${projectListId}/items`, { fields });
      }
      await loadProjectsTop8();
    }
    async function deleteProject(itemId){
      if (ROLE!=='admin') return;
      await graphDELETE(`/sites/${spSiteId}/lists/${projectListId}/items/${itemId}`);
      await loadProjectsTop8();
    }

    // Binder: auto create/update a Project item from inputs
    ['projTitle','projAddress','projOwner','projStart','projSales','projActive'].forEach(id=>{
      const el = ()=>document.getElementById(id);
      document.addEventListener('change', async (e)=>{
        if (e.target && e.target.id===id) {
          const addr = document.getElementById('projAddress').value;
          if (!addr) return;
          // find by address
          try {
            const found = await graphGET(`/sites/${spSiteId}/lists/${projectListId}/items?$filter=fields/Project%20Address eq '${encodeURIComponent(addr)}'&$top=1&$expand=fields`);
            const item = (found.value||[])[0];
            await saveProject(item? item.id : null);
          } catch(err){ /* ignore */ }
        }
      });
    });

    // Tasks list (similar wiring)
    async function loadTasks(){
      const items = await graphGET(`/sites/${spSiteId}/lists/${taskListId}/items?$top=50&$expand=fields`);
      const tbody = document.querySelector('#taskTable tbody');
      tbody.innerHTML='';
      (items.value||[]).forEach(it=>{
        const f = it.fields||{};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.Title||''}</td>
          <td>${f.Address||''}</td>
          <td>${f['Start Date']||''}</td>
          <td>${f['End Date']||''}</td>
          <td>${f.Quantity||''}</td>
          <td>${f['Unit Cost']||''}</td>
          <td>${f['Total Cost']||''}</td>
          <td>${f.Allocation||''}</td>
          <td>${f.Sprint||''}</td>
          <td>${f.Assignee||''}</td>
          <td class="actions">
            <button class="btn btn-sm ${ROLE==='viewer'?'hidden':''}" data-edit="${it.id}">Edit</button>
            <button class="btn danger btn-sm ${ROLE==='admin'?'':'hidden'}" data-del="${it.id}">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.addEventListener('click', ()=>openTaskModal(btn.getAttribute('data-edit')));
      });
      tbody.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=>deleteTask(btn.getAttribute('data-del')));
      });
    }

    function openTaskModal(itemId){
      document.getElementById('taskModal').style.display='flex';
      document.getElementById('taskClose').onclick = ()=>{ document.getElementById('taskModal').style.display='none'; };
      if (itemId){
        graphGET(`/sites/${spSiteId}/lists/${taskListId}/items/${itemId}?$expand=fields`).then(item=>{
          const f=item.fields||{};
          taskTitle.value = f.Title||''; taskAddress.value=f.Address||''; taskStart.value=f['Start Date']||''; taskEnd.value=f['End Date']||'';
          taskQty.value=f.Quantity||''; taskUnitCost.value=f['Unit Cost']||''; taskTotalCost.value=f['Total Cost']||''; taskAllocation.value=f.Allocation||'';
          taskSprint.value=f.Sprint||''; taskAssignee.value=f.Assignee||''; taskDesc.value=f.Description||''; taskNotes.value=f.Notes||'';
          document.getElementById('taskSave').onclick = ()=>saveTask(itemId);
          document.getElementById('taskDelete').onclick = ()=>deleteTask(itemId);
        });
      } else {
        taskTitle.value = ''; taskAddress.value=''; taskStart.value=''; taskEnd.value=''; taskQty.value=''; taskUnitCost.value=''; taskTotalCost.value=''; taskAllocation.value=''; taskSprint.value=''; taskAssignee.value=''; taskDesc.value=''; taskNotes.value='';
        document.getElementById('taskSave').onclick = ()=>saveTask(null);
        document.getElementById('taskDelete').classList.add('hidden');
      }
    }

    async function ensureTaskPhotosFolder(){
      // Ensure default Documents drive exists and TaskPhotos folder is created
      const drive = await graphGET(`/sites/${spSiteId}/drive`);
      // create folder (ignore if exists)
      try { await graphPOST(`/sites/${spSiteId}/drive/root/children`, { name: 'TaskPhotos', folder: {}, "@microsoft.graph.conflictBehavior":"rename" }); } catch(e){}
      return drive.id;
    }

    async function saveTask(itemId){
      const fields = {
        Title: taskTitle.value,
        Address: taskAddress.value,
        'Start Date': taskStart.value,
        'End Date': taskEnd.value,
        Quantity: parseFloat(taskQty.value||'0'),
        'Unit Cost': parseFloat(taskUnitCost.value||'0'),
        'Total Cost': parseFloat(taskTotalCost.value||'0'),
        Allocation: parseFloat(taskAllocation.value||'0'),
        Sprint: taskSprint.value,
        Assignee: taskAssignee.value,
        Description: taskDesc.value,
        Notes: taskNotes.value
      };
      // Relate to Project via Address lookup
      if (fields.Address){ /* binding through Address */ }
      if (itemId){
        await graphPATCH(`/sites/${spSiteId}/lists/${taskListId}/items/${itemId}/fields`, fields);
      } else {
        const created = await graphPOST(`/sites/${spSiteId}/lists/${taskListId}/items`, { fields });
        itemId = created.id;
      }
      // Photos upload
      const files = document.getElementById('taskPhotos').files;
      if (files && files.length){
        await ensureTaskPhotosFolder();
        for (const file of files){
          const arrayBuffer = await file.arrayBuffer();
          const uploadResp = await fetch(`https://graph.microsoft.com/v1.0/sites/${spSiteId}/drive/root:/TaskPhotos/${encodeURIComponent(file.name)}:/content`, {
            method:'PUT', headers:{ 'Authorization':'Bearer '+await getToken(), 'Content-Type': file.type || 'application/octet-stream' }, body: arrayBuffer
          });
          if (!uploadResp.ok) console.warn('Photo upload failed', file.name);
        }
      }
      document.getElementById('taskModal').style.display='none';
      await loadTasks();
    }
    async function deleteTask(itemId){ if (ROLE!=='admin') return; await graphDELETE(`/sites/${spSiteId}/lists/${taskListId}/items/${itemId}`); await loadTasks(); }

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const name = t.getAttribute('data-tab');
        document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
        document.getElementById('tab-'+name).classList.remove('hidden');
      });
    });

    // Auth lifecycle
    async function onSignedIn(){
      document.getElementById('signInCard').style.display='none';
      document.getElementById('appRoot').style.display='block';
      document.getElementById('userEmail').classList.remove('hidden');
      document.getElementById('signOutBtn').classList.remove('hidden');
      document.getElementById('signInBtn').classList.add('hidden');
      document.getElementById('cardSignInBtn').classList.add('hidden');
      document.getElementById('userEmail').textContent = account?.username || '';
      await resolveRole();
      await resolveSharePointIds();
      await loadProjectsTop8();
      await loadTasks();
    }

    async function signIn(){
      try {
        const login = await msalInstance.loginPopup(loginRequest);
        account = login.account;
        msalInstance.setActiveAccount(account);
        onSignedIn();
      } catch (e) { console.error(e); }
    }
    function signOut(){ msalInstance.logoutPopup({ postLogoutRedirectUri: window.location.origin }); }

    document.getElementById('signInBtn').addEventListener('click', signIn);
    document.getElementById('cardSignInBtn').addEventListener('click', signIn);
    document.getElementById('signOutBtn').addEventListener('click', signOut);

    // App init: if we already have an account, proceed
    window.addEventListener('DOMContentLoaded', ()=>{
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length){ account = accounts[0]; msalInstance.setActiveAccount(account); onSignedIn(); }
    });

    // UI buttons
    document.getElementById('btnAddProject').addEventListener('click', ()=>{ editProject(null); });
    document.getElementById('btnAddTask').addEventListener('click', ()=>{ openTaskModal(null); });
  </script>
</body>
</html>
