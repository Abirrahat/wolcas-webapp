<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WOLCAS</title>
  <!-- CSP updated to avoid inline/script/logo blocks and allow Graph/AAD only -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://upload.wikimedia.org; connect-src 'self' https://graph.microsoft.com https://login.microsoftonline.com; frame-src 'self' https://login.microsoftonline.com; font-src 'self' data:; object-src 'none'; base-uri 'self'; form-action 'self' https://login.microsoftonline.com;" />
  <!-- Use project-relative favicon to stop domain-root 404 -->
  <link rel="icon" href="./Construction_icon.svg" type="image/svg+xml" />
  <style>
    /* ===== Preserve your original compact layout (no redesign) ===== */
    body { font-family: Segoe UI, Tahoma, Arial, sans-serif; margin:0; background:#fff; color:#111; }
    header { display:flex; align-items:center; gap:12px; padding:8px 12px; border-bottom:1px solid #eee; }
    header img.logo { height:56px; width:auto; }
    header h1 { font-size:18px; margin:0; font-weight:600; }
    header nav { margin-left:auto; display:flex; align-items:center; gap:8px; }
    .badge { background:#eef2ff; color:#3741a7; border:1px solid #c7cff7; padding:4px 8px; border-radius:14px; font-size:12px; }
    .btn { display:inline-block; padding:6px 10px; border:1px solid #222; border-radius:6px; background:#fff; cursor:pointer; }
    .btn.primary { background:#2563eb; color:#fff; border-color:#2563eb; }
    .btn.danger { background:#bf1c1c; color:#fff; border-color:#bf1c1c; }
    .toolbar { padding:8px 12px; border-bottom:1px solid #eee; }
    .tabs { display:flex; gap:16px; }
    .tab { padding:6px 8px; border-radius:6px; border:1px solid #eee; background:#fafafa; cursor:pointer; }
    .tab.active { background:#fff; border-color:#ddd; }
    main { padding:8px 12px; }
    .grid { display:grid; grid-template-columns: 1fr 380px; gap:18px; align-items:start; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; font-size:14px; }
    .right-actions { text-align:right; margin-bottom:8px; }
    .hidden { display:none !important; }
    .panel { border:1px solid #ddd; padding:10px; border-radius:6px; background:#fff; }
    .field { margin-bottom:8px; }
    .field label { display:block; font-size:12px; color:#555; margin-bottom:4px; }
    .field input, .field textarea, .field select { width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; }
    /* Sign-in only card (white) */
    #signInCard { max-width:400px; margin:80px auto; border:1px solid #e5e7eb; border-radius:10px; padding:18px; background:#fff; }
    #signInCard h2 { margin:0 0 6px; font-size:18px; }
    #signInCard p { margin:0 0 12px; color:#666; }
  </style>
</head>
<body>
  <header>
    <img class="logo" alt="Logo" src="https://upload.wikimedia.org/wikipedia/commons/5/59/Construction_icon.svg" />
    <h1>WOLCAS</h1>
    <nav>
      <span id="userEmail" class="badge hidden"></span>
      <button id="signInBtn" class="btn primary">Sign in</button>
      <button id="signOutBtn" class="btn danger hidden">Sign out</button>
    </nav>
  </header>

  <div class="toolbar">
    <div class="tabs">
      <div class="tab active" data-tab="projects">üìÅ Projects</div>
      <div class="tab" data-tab="tasks">üìù Tasks</div>
      <div class="tab" data-tab="dashboard">üìä Dashboard</div>
      <div class="tab" data-tab="settings">‚öôÔ∏è Settings</div>
    </div>
  </div>

  <!-- Sign-in Only (white background) -->
  <section id="signInCard">
    <h2>Sign in to continue</h2>
    <p>Only permitted company users can use WOLCAS.</p>
    <button id="cardSignInBtn" class="btn primary">Sign in with Microsoft</button>
  </section>

  <main id="appRoot" class="hidden">
    <!-- ===== Projects Tab (table left, editor right) ===== -->
    <section id="tab-projects">
      <div class="right-actions"><button id="btnAddProject" class="btn hidden">Add Project</button></div>
      <div class="grid">
        <div>
          <table id="projectTable">
            <thead>
              <tr>
                <th>Title</th>
                <th>Project Address</th>
                <th>Owner</th>
                <th>Start Date</th>
                <th>Expected Sales</th>
                <th>Active</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <aside class="panel">
          <div class="field"><label>Title</label><input id="projTitle" /></div>
          <div class="field"><label>Project Address</label><input id="projAddress" /></div>
          <div class="field"><label>Owner</label><input id="projOwner" /></div>
          <div class="field"><label>Start Date</label><input id="projStart" type="date" /></div>
          <div class="field"><label>Expected Sales</label><input id="projSales" type="number" step="0.01" /></div>
          <div class="field"><label><input id="projActive" type="checkbox" /> Active</label></div>
          <div>
            <button id="projSave" class="btn">Save</button>
            <button id="projDelete" class="btn danger hidden">Delete</button>
          </div>
        </aside>
      </div>
    </section>

    <!-- ===== Tasks Tab ===== -->
    <section id="tab-tasks" class="hidden">
      <div class="right-actions"><button id="btnAddTask" class="btn hidden">Add Task</button></div>
      <div class="grid">
        <div>
          <table id="taskTable">
            <thead>
              <tr>
                <th>Task name</th>
                <th>Address</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Quantity</th>
                <th>Unit Cost</th>
                <th>Total Cost</th>
                <th>Allocation</th>
                <th>Sprint</th>
                <th>Assignee</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <aside class="panel">
          <div class="field"><label>Title</label><input id="taskTitle" /></div>
          <div class="field"><label>Address</label><input id="taskAddress" /></div>
          <div class="field"><label>Start Date</label><input id="taskStart" type="date" /></div>
          <div class="field"><label>End Date</label><input id="taskEnd" type="date" /></div>
          <div class="field"><label>Quantity</label><input id="taskQty" type="number" step="0.01" /></div>
          <div class="field"><label>Unit Cost</label><input id="taskUnitCost" type="number" step="0.01" /></div>
          <div class="field"><label>Total Cost</label><input id="taskTotalCost" type="number" step="0.01" /></div>
          <div class="field"><label>Allocation</label><input id="taskAllocation" type="number" step="0.01" /></div>
          <div class="field"><label>Sprint</label><input id="taskSprint" /></div>
          <div class="field"><label>Assignee</label><input id="taskAssignee" /></div>
          <div class="field"><label>Description</label><textarea id="taskDesc"></textarea></div>
          <div class="field"><label>Notes</label><textarea id="taskNotes"></textarea></div>
          <div class="field"><label>Photos</label><input id="taskPhotos" type="file" accept="image/*" multiple /></div>
          <div>
            <button id="taskSave" class="btn">Save</button>
            <button id="taskDelete" class="btn danger hidden">Delete</button>
          </div>
        </aside>
      </div>
    </section>

    <!-- ===== Dashboard ===== -->
    <section id="tab-dashboard" class="hidden">
      <div class="panel">
        <h3>Dashboard</h3>
        <ul id="dashboardTotals"></ul>
        <hr />
        <h4>Recent Activity</h4>
        <ul id="recentActivity"></ul>
      </div>
    </section>

    <!-- ===== Settings ===== -->
    <section id="tab-settings" class="hidden">
      <div class="panel">
        <div class="field"><label>Company name</label><input id="companyName" /></div>
        <div class="field"><label>Logo URL</label><input id="companyLogo" /></div>
        <div><button id="settingsSave" class="btn">Save</button></div>
      </div>
    </section>
  </main>

  <!-- Local MSAL (no external CDNs) -->
  <script src="./msal-browser.min.js"></script>
  <script>
    // ===== MSAL SPA config (no client secret in front-end) =====
    const msalConfig = {
      auth: {
        clientId: '827656f8-3a21-4d69-b6e5-c35e2ec2fb71',
        authority: 'https://login.microsoftonline.com/97d84781-b85c-4034-a0d0-588e7b442e45',
        redirectUri: 'https://abirrahat.github.io/wolcas-webapp/auth',
        navigateToLoginRequestUrl: false
      },
      cache: { cacheLocation: 'sessionStorage', storeAuthStateInCookie: false },
      system: { allowRedirectInIframe: false }
    };
    const loginRequest = {
      scopes: ['User.Read','Sites.ReadWrite.All','Files.ReadWrite.All','Group.Read.All'],
      prompt: 'select_account'
    };
    const msalInstance = new msal.PublicClientApplication(msalConfig);
    let account = null; let ROLE = 'viewer';

    // ===== Tabs (unchanged behavior) =====
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const name = t.getAttribute('data-tab');
        document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden'));
        document.getElementById('tab-'+name).classList.remove('hidden');
      });
    });

    // ===== Graph helpers =====
    const graphBase = 'https://graph.microsoft.com/v1.0';
    async function getToken(){
      const active = msalInstance.getActiveAccount() || account; if (!active) throw new Error('No active account');
      try { const s = await msalInstance.acquireTokenSilent({ account: active, scopes: loginRequest.scopes }); return s.accessToken; }
      catch(e){ const p = await msalInstance.acquireTokenPopup(loginRequest); return p.accessToken; }
    }
    async function graph(path, opts={}){
      const token = await getToken();
      const resp = await fetch(graphBase+path, { ...opts, headers: { 'Authorization':'Bearer '+token, 'Content-Type':'application/json', ...(opts.headers||{}) } });
      if (!resp.ok){ const txt = await resp.text(); throw new Error('Graph '+(opts.method||'GET')+' failed '+resp.status+' '+txt); }
      return resp.status===204 ? {} : await resp.json();
    }

    // ===== RBAC: map via groups =====
    async function resolveRole(){
      try{
        const groups = await graph('/me/transitiveMemberOf?$select=displayName');
        const names = (groups.value||[]).map(g=>g.displayName?.toLowerCase()||'');
        if (names.some(n=> n.includes('wolcas') && n.includes('admin'))) ROLE='admin';
        else if (names.some(n=> n.includes('wolcas') && n.includes('editor'))) ROLE='editor';
        else ROLE='viewer';
      }catch{ ROLE='viewer'; }
      applyRoleUI();
    }
    function applyRoleUI(){
      document.getElementById('btnAddProject').classList.toggle('hidden', ROLE==='viewer');
      document.getElementById('btnAddTask').classList.toggle('hidden', ROLE==='viewer');
      document.getElementById('projDelete').classList.toggle('hidden', ROLE!=='admin');
      document.getElementById('taskDelete').classList.toggle('hidden', ROLE!=='admin');
      // Allocation editable only for admin
      document.getElementById('taskAllocation').disabled = (ROLE!=='admin');
    }

    // ===== SharePoint site/list IDs =====
    const SP_HOST = 'architektica-my.sharepoint.com';
    const SP_PATH = '/personal/abir_architektica_com';
    let spSiteId=null, projectListId=null, taskListId=null;
    async function resolveSharePointIds(){
      const site = await graph(`/sites/${SP_HOST}:${SP_PATH}`);
      spSiteId = site.id;
      const lists = await graph(`/sites/${spSiteId}/lists?$select=id,displayName`);
      for (const l of (lists.value||[])){
        if (l.displayName==='Project') projectListId = l.id;
        if (l.displayName==='Task') taskListId = l.id;
      }
    }

    // ===== Projects =====
    async function loadProjectsTop8(){
      const items = await graph(`/sites/${spSiteId}/lists/${projectListId}/items?$top=8&$expand=fields`);
      const tbody = document.querySelector('#projectTable tbody'); tbody.innerHTML='';
      (items.value||[]).forEach(it=>{
        const f = it.fields||{};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.Title||''}</td>
          <td>${f['Project Address']||''}</td>
          <td>${f.Owner||''}</td>
          <td>${f['Start Date']||''}</td>
          <td>${f['Expected Sales']||''}</td>
          <td>${f.Active? '‚úîÔ∏è':''}</td>
          <td>
            <button class="btn ${ROLE==='viewer'?'hidden':''}" data-edit="${it.id}">Edit</button>
            <button class="btn danger ${ROLE==='admin'?'':'hidden'}" data-del="${it.id}">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('[data-edit]').forEach(btn=> btn.addEventListener('click', ()=> editProject(btn.getAttribute('data-edit'))));
      tbody.querySelectorAll('[data-del]').forEach(btn=> btn.addEventListener('click', ()=> deleteProject(btn.getAttribute('data-del'))));
    }
    async function editProject(id){
      if (!id){
        projTitle.value=''; projAddress.value=''; projOwner.value='';
        projStart.value=''; projSales.value=''; projActive.checked=false;
        document.getElementById('projDelete').classList.add('hidden');
        document.getElementById('projSave').onclick = ()=> saveProject(null);
        return;
      }
      const item = await graph(`/sites/${spSiteId}/lists/${projectListId}/items/${id}?$expand=fields`);
      const f = item.fields||{};
      projTitle.value=f.Title||''; projAddress.value=f['Project Address']||''; projOwner.value=f.Owner||'';
      projStart.value=f['Start Date']||''; projSales.value=f['Expected Sales']||''; projActive.checked=!!f.Active;
      document.getElementById('projDelete').classList.toggle('hidden', ROLE!=='admin');
      document.getElementById('projSave').onclick = ()=> saveProject(id);
      document.getElementById('projDelete').onclick = ()=> deleteProject(id);
    }
    async function saveProject(id){
      const fields = {
        Title: projTitle.value,
        'Project Address': projAddress.value,
        Owner: projOwner.value,
        'Start Date': projStart.value,
        'Expected Sales': parseFloat(projSales.value||'0'),
        Active: projActive.checked
      };
      if (id) await graph(`/sites/${spSiteId}/lists/${projectListId}/items/${id}/fields`, { method:'PATCH', body: JSON.stringify(fields) });
      else await graph(`/sites/${spSiteId}/lists/${projectListId}/items`, { method:'POST', body: JSON.stringify({ fields }) });
      await loadProjectsTop8();
    }
    async function deleteProject(id){ if (ROLE!=='admin') return; await graph(`/sites/${spSiteId}/lists/${projectListId}/items/${id}`, { method:'DELETE' }); await loadProjectsTop8(); }

    // Binder: auto create/update based on Project Address
    ['projTitle','projAddress','projOwner','projStart','projSales','projActive'].forEach(id=>{
      document.getElementById(id).addEventListener('change', async ()=>{
        const addr = document.getElementById('projAddress').value; if (!addr) return;
        try{
          const found = await graph(`/sites/${spSiteId}/lists/${projectListId}/items?$filter=fields/Project%20Address eq '${encodeURIComponent(addr)}'&$top=1&$expand=fields`);
          const item = (found.value||[])[0]; await saveProject(item? item.id : null);
        }catch{}
      });
    });

    // ===== Tasks =====
    async function loadTasks(){
      const items = await graph(`/sites/${spSiteId}/lists/${taskListId}/items?$top=50&$expand=fields`);
      const tbody = document.querySelector('#taskTable tbody'); tbody.innerHTML='';
      (items.value||[]).forEach(it=>{
        const f = it.fields||{};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.Title||''}</td>
          <td>${f.Address||''}</td>
          <td>${f['Start Date']||''}</td>
          <td>${f['End Date']||''}</td>
          <td>${f.Quantity||''}</td>
          <td>${f['Unit Cost']||''}</td>
          <td>${f['Total Cost']||''}</td>
          <td>${f.Allocation||''}</td>
          <td>${f.Sprint||''}</td>
          <td>${f.Assignee||''}</td>
          <td>
            <button class="btn ${ROLE==='viewer'?'hidden':''}" data-edit="${it.id}">Edit</button>
            <button class="btn danger ${ROLE==='admin'?'':'hidden'}" data-del="${it.id}">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('[data-edit]').forEach(btn=> btn.addEventListener('click', ()=> openTaskEditor(btn.getAttribute('data-edit'))));
      tbody.querySelectorAll('[data-del]').forEach(btn=> btn.addEventListener('click', ()=> deleteTask(btn.getAttribute('data-del'))));
    }
    async function openTaskEditor(id){
      if (!id){
        taskTitle.value=''; taskAddress.value=''; taskStart.value=''; taskEnd.value=''; taskQty.value=''; taskUnitCost.value=''; taskTotalCost.value=''; taskAllocation.value=''; taskSprint.value=''; taskAssignee.value=''; taskDesc.value=''; taskNotes.value='';
        document.getElementById('taskDelete').classList.add('hidden');
        document.getElementById('taskSave').onclick = ()=> saveTask(null);
        return;
      }
      const item = await graph(`/sites/${spSiteId}/lists/${taskListId}/items/${id}?$expand=fields`);
      const f=item.fields||{};
      taskTitle.value=f.Title||''; taskAddress.value=f.Address||''; taskStart.value=f['Start Date']||''; taskEnd.value=f['End Date']||'';
      taskQty.value=f.Quantity||''; taskUnitCost.value=f['Unit Cost']||''; taskTotalCost.value=f['Total Cost']||''; taskAllocation.value=f.Allocation||'';
      taskSprint.value=f.Sprint||''; taskAssignee.value=f.Assignee||''; taskDesc.value=f.Description||''; taskNotes.value=f.Notes||'';
      document.getElementById('taskDelete').classList.toggle('hidden', ROLE!=='admin');
      document.getElementById('taskSave').onclick = ()=> saveTask(id);
      document.getElementById('taskDelete').onclick = ()=> deleteTask(id);
    }
    async function ensureTaskPhotosFolder(){
      try{ await graph(`/sites/${spSiteId}/drive/root/children`, { method:'POST', body: JSON.stringify({ name:'TaskPhotos', folder:{}, '@microsoft.graph.conflictBehavior':'rename' }) }); }catch{}
    }
    async function saveTask(id){
      const fields = { Title: taskTitle.value, Address: taskAddress.value, 'Start Date': taskStart.value, 'End Date': taskEnd.value, Quantity: parseFloat(taskQty.value||'0'), 'Unit Cost': parseFloat(taskUnitCost.value||'0'), 'Total Cost': parseFloat(taskTotalCost.value||'0'), Allocation: parseFloat(taskAllocation.value||'0'), Sprint: taskSprint.value, Assignee: taskAssignee.value, Description: taskDesc.value, Notes: taskNotes.value };
      if (id) await graph(`/sites/${spSiteId}/lists/${taskListId}/items/${id}/fields`, { method:'PATCH', body: JSON.stringify(fields) });
      else { const created = await graph(`/sites/${spSiteId}/lists/${taskListId}/items`, { method:'POST', body: JSON.stringify({ fields }) }); id = created.id; }
      // Photos
      const files = document.getElementById('taskPhotos').files; if (files && files.length){
        await ensureTaskPhotosFolder();
        const token = await getToken();
        for (const f of files){
          const buf = await f.arrayBuffer();
          const up = await fetch(`${graphBase}/sites/${spSiteId}/drive/root:/TaskPhotos/${encodeURIComponent(f.name)}:/content`, { method:'PUT', headers:{ 'Authorization':'Bearer '+token, 'Content-Type': f.type || 'application/octet-stream' }, body: buf });
          if (!up.ok) console.warn('Upload failed', f.name);
        }
      }
      await loadTasks();
    }
    async function deleteTask(id){ if (ROLE!=='admin') return; await graph(`/sites/${spSiteId}/lists/${taskListId}/items/${id}`, { method:'DELETE' }); await loadTasks(); }

    // ===== Auth lifecycle (open same-origin /auth popup to avoid COOP warnings) =====
    async function onSignedIn(){
      document.getElementById('signInCard').classList.add('hidden');
      document.getElementById('appRoot').classList.remove('hidden');
      document.getElementById('userEmail').classList.remove('hidden');
      document.getElementById('signOutBtn').classList.remove('hidden');
      document.getElementById('signInBtn').classList.add('hidden');
      document.getElementById('cardSignInBtn').classList.add('hidden');
      document.getElementById('userEmail').textContent = account?.username || '';
      await resolveRole();
      await resolveSharePointIds();
      await loadProjectsTop8();
      await loadTasks();
    }
    function signIn(){
      const popup = window.open('./auth', 'WOLCAS_AUTH', 'width=520,height=680,noopener,noreferrer');
      window.addEventListener('message', async (ev) => {
        if (ev.data && ev.data.type === 'MSAL_AUTH_SUCCESS') {
          account = ev.data.account;
          msalInstance.setActiveAccount(account);
          await onSignedIn();
        }
      }, { once: true });
    }
    function signOut(){ msalInstance.logoutPopup({ postLogoutRedirectUri: window.location.origin }); }

    document.getElementById('signInBtn').addEventListener('click', signIn);
    document.getElementById('cardSignInBtn').addEventListener('click', signIn);
    document.getElementById('signOutBtn').addEventListener('click', signOut);

    document.getElementById('btnAddProject').addEventListener('click', ()=> editProject(null));
    document.getElementById('btnAddTask').addEventListener('click', ()=> openTaskEditor(null));

    window.addEventListener('DOMContentLoaded', ()=>{
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length){ account = accounts[0]; msalInstance.setActiveAccount(account); onSignedIn(); }
    });
  </script>
</body>
</html>
