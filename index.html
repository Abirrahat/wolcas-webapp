
<!doctype html>
<html lang">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WOLCAS</title>

  <!-- Styles (white background, 56px logo) -->
  <style>
    :root { color-scheme: light; }
    body.wolcas-body { background:#fff; color:#222; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; }
    .app-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eee; background:#fff; position:sticky; top:0; }
    .brand-logo { height:56px; }
    .auth-nav { display:flex; gap:8px; align-items:center; }
    .user-email { color:#555; margin-right:6px; }
    .hidden { display:none !important; }
    .signin-card { max-width:360px; margin:12vh auto; padding:24px; border:1px solid #eee; border-radius:8px; text-align:center; background:#fff; }
    main { padding:12px 16px; }
    h2 { margin:12px 0 6px; }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; }
    dialog { width:720px; max-width:95vw; border:1px solid #ddd; border-radius:8px; padding:0; }
    dialog form { padding:16px; }
    dialog menu { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    label { display:block; margin:6px 0; }
    label.checkbox { display:flex; align-items:center; gap:8px; }
    .row { display:grid; grid-template-columns: repeat(4, minmax(140px, 1fr)); gap:8px; }
    .stats-row { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:8px; margin-bottom:12px; }
    .stat { padding:8px 12px; background:#f9fafb; border:1px solid #eee; border-radius:8px; }
    .rbac-admin { /* elements visible/editable only when ROLE==='admin' */ }
    .rbac-not-viewer { /* visible only when ROLE!=='viewer' */ }
    #btnAddProject, #btnAddTask { float:right; margin-bottom:8px; }
  </style>

  <!-- MSAL (no modules; popup + PKCE) -->
  <script src="https://alcdn.msaer/2.38.0/js/msal-browser.min.js</script>
</head>
<body class="wolcas-body">

  <!-- Header -->
  <header class="app-header">
    <img src="assets/logo.pngclass="auth-nav">
      <span id="userEmail" class="user-email"></span>
      <button id="btnSignIn">Sign in</button>
      <button id="btnSignOut" class="hidden">Sign out</button>
    </nav>
  </header>

  <!-- Signed-out UX (white background with card) -->
  <main id="signedOutMain">
    <section class="signin-card">
      <h1>WOLCAS</h1>
      <p>Sign in to manage Projects & Tasks.</p>
      <button id="btnSignInCard">Sign in</button>
    </section>
  </main>

  <!-- App UX (only visible after sign-in) -->
  <main id="appMain" class="hidden">
    <section id="dashboard">
      <h2>Dashboard</h2>
      <div class="stats-row">
        <div class="stat"><h3>Total Projects</h3><span id="statTotalProjects">–</span></div>
        <div class="stat"><h3>Active Projects</h3><span id="statActiveProjects">–</span></div>
        <div class="stat"><h3>Completed Projects</h3><span id="statCompletedProjects">–</span></div>
        <div class="stat"><h3>Total Costs (tasks)</h3><span id="statTotalCosts">–</span></div>
        <div class="stat"><h3>Total Sales (expected)</h3><span id="statTotalSales">–</span></div>
      </div>
    </section>

    <!-- Projects -->
    <section id="projects">
      <h2>Projects</h2>
      <button id="btnAddProject" class="rbac-not-viewer">Add Project</button>
      <table id="projectTable">
        <thead><tr>
          <th>Title</th><th>Owner</th><th>Start Date</th><th>Expected Sales</th><th>Active</th><th>Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>

      <!-- Editor -->
      <dialog id="projectModal">
        <form id="projectForm">
          <label>Title <input name="Title" required></label>
          <label>Owner <input name="Owner"></label>
          <label>Start Date <input type="date" name="StartDate"></label>
          <label>Expected Sales <input type="number" step="0.01" name="ExpectedSales"></label>
          <label class="checkbox">Active <input type="checkbox" name="Active"></label>
          <menu>
            <button type="submit" id="btnSaveProject">Save</button>
            <button type="button" id="btnDeleteProject" class="rbac-admin">Delete</button>
            <button type="button" id="btnCloseProject">Close</button>
          </menu>
        </form>
      </dialog>
    </section>

    <!-- Tasks -->
    <section id="tasks">
      <h2>Tasks</h2>
      <button id="btnAddTask" class="rbac-not-viewer">Add Task</button>
      <table id="taskTable">
        <thead><tr>
          <th>Title</th><th>Address</th><th>Start Date</th><th>End Date</th>
          <th>Quantity</th><th>Unit Cost</th><th>Total Cost</th><th>Allocation</th>
          <th>Sprint</th><th>Assignee</th><th>Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>

      <!-- Editor -->
      <dialog id="taskModal">
        <form id="taskForm">
          <label>Title <input name="Title" required></label>
          <label>Address <input name="Address"></label>
          <label>Start Date <input type="date" name="StartDate"></label>
          <label>End Date <input type="date" name="EndDate"></label>
          <div class="row">
            <label>Quantity <input type="number" step="0.01" name="Quantity"></label>
            <label>Unit Cost <input type="number" step="0.01" name="UnitCost"></label>
            <label>Total Cost <input type="number" step="0.01" name="TotalCost"></label>
            <label class="rbac-admin">Allocation <input type="number" step="0.01" name="Allocation"></label>
          </div>
          <label>Sprint <input name="Sprint"></label>
          <label>Assignee <input name="Assignee"></label>
          <label>Description <textarea name="Description"></textarea></label>
          <label>Notes <textarea name="Notes"></textarea></label>
          <label>Photos <input type="file" id="taskPhotos" multiple accept="image/*"></label>
          <menu>
            <button type="submit" id="btnSaveTask">Save</button>
            <button type="button" id="btnDeleteTask" class="rbac-admin">Delete</button>
            <button type="button" id="btnCloseTask">Close</button>
          </menu>
        </form>
      </dialog>
    </section>
  </main>

  <!-- App Bundle (all logic inline; no modules) -->
  <script>
    /******************** CONFIG ********************/
    const CONFIG = {
      clientId: "827656f8-3a21-4d69-b6e5-c35e2ec2fb71",
      tenantId: "97d84781-b85c-4034-a0d0-588e7b442e45",
      redirectUri: "https://abirrahat.github.io/wolcas-webapp/auth",
      graphBase: "https://graph.microsoft.com/v1.0",
      scopes: ["User.Read","Sites.ReadWrite.All","Files.ReadWrite.All"],
      sharepointHost: "architektica-my.sharepoint.com",
      personalPath: "/personal/abir_architektica_com",
      taskListName: "Task",
      projectListName: "Project"
    };

    /******************** MSAL ********************/
    const msalInstance = new msal.PublicClientApplication({
      auth: {
        clientId: CONFIG.clientId,
        authority: `https://login.microsoftonline.com/${CONFIG.tenantId}`,
        redirectUri: CONFIG.redirectUri,
        navigateToLoginRequestUrl: false
      },
      cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: false }
    });

    /******************** DOM ********************/
    const $ = (id) => document.getElementById(id);

    function showSignedOut() {
      $("signedOutMain").classList.remove("hidden");
      $("appMain").classList.add("hidden");
      $("btnSignIn").classList.remove("hidden");
      $("btnSignOut").classList.add("hidden");
      $("userEmail").textContent = "";
    }

    function showSignedIn(acct) {
      $("signedOutMain").classList.add("hidden");
      $("appMain").classList.remove("hidden");
      $("btnSignIn").classList.add("hidden");
      $("btnSignOut").classList.remove("hidden");
      $("userEmail").textContent = acct.username || acct.name || "";
    }

    /******************** RBAC ********************/
    function getRole() {
      const acct = msalInstance.getActiveAccount();
      const roles = (acct?.idTokenClaims?.roles || []);
      if (roles.includes("admin")) return "admin";
      if (roles.includes("editor")) return "editor";
      return "viewer";
    }
    function applyRBAC() {
      const role = getRole();
      document.querySelectorAll(".rbac-admin").forEach(el => {
        el.style.display = (role === "admin") ? "" : "none";
        const input = el.querySelector("input,textarea,select");
        if (input) input.disabled = (role !== "admin");
      });
      document.querySelectorAll(".rbac-not-viewer").forEach(el => {
        el.style.display = (role === "viewer") ? "none" : "";
      });
    }

    /******************** AUTH ********************/
    async function signIn() {
      try {
        const resp = await msalInstance.loginPopup({ scopes: CONFIG.scopes });
        msalInstance.setActiveAccount(resp.account);
        showSignedIn(resp.account);
        applyRBAC();
        await boot();  // load lists etc.
      } catch (e) {
        console.error("Sign-in failed:", e);
        alert("Sign-in failed. See console for details.");
      }
    }
    async function signOut() {
      await msalInstance.logoutPopup({ mainWindowRedirectUri: "https://abirrahat.github.io/wolcas-webapp/" });
      showSignedOut();
    }
    async function getGraphToken() {
      const acct = msalInstance.getActiveAccount();
      const result = await msalInstance.acquireTokenSilent({ scopes: CONFIG.scopes, account: acct });
      return result.accessToken;
    }
    async function graphFetch(path, options = {}) {
      const token = await getGraphToken();
      const res = await fetch(`${CONFIG.graphBase}${path}`, {
        ...options,
        headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json", ...(options.headers||{}) }
      });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${await res.text()}`);
      return res.status === 204 ? null : res.json();
    }

    /******************** SharePoint Site & Lists ********************/
    async function resolveSiteAndLists() {
      const site = await graphFetch(`/sites/${CONFIG.sharepointHost}:${CONFIG.personalPath}`);
      const siteId = site.id;

      const lists = await graphFetch(`/sites/${siteId}/lists`);
      const taskList = lists.value.find(l => l.displayName === CONFIG.taskListName);
      const projectList = lists.value.find(l => l.displayName === CONFIG.projectListName);
      if (!taskList || !projectList) throw new Error("Task or Project list not found.");

      return { siteId, taskListId: taskList.id, projectListId: projectList.id };
    }

    /******************** Projects CRUD ********************/
    async function getTopProjects(siteId, projectListId, top=8) {
      return graphFetch(`/sites/${siteId}/lists/${projectListId}/items?$top=${top}&$expand=fields`);
    }
    async function createOrUpdateProject(siteId, projectListId, itemId, fields) {
      if (!itemId) {
        return graphFetch(`/sites/${siteId}/lists/${projectListId}/items`, { method:"POST", body: JSON.stringify({ fields }) });
      } else {
        return graphFetch(`/sites/${siteId}/lists/${projectListId}/items/${itemId}/fields`, { method:"PATCH", body: JSON.stringify(fields) });
      }
    }
    async function deleteProject(siteId, projectListId, itemId) {
      return graphFetch(`/sites/${siteId}/lists/${projectListId}/items/${itemId}`, { method:"DELETE" });
    }

    /******************** Tasks CRUD ********************/
    async function getTasks(siteId, taskListId) {
      return graphFetch(`/sites/${siteId}/lists/${taskListId}/items?$expand=fields`);
    }
    async function createOrUpdateTask(siteId, taskListId, itemId, fields) {
      if (!itemId) {
        return graphFetch(`/sites/${siteId}/lists/${taskListId}/items`, { method:"POST", body: JSON.stringify({ fields }) });
      } else {
        return graphFetch(`/sites/${siteId}/lists/${taskListId}/items/${itemId}/fields`, { method:"PATCH", body: JSON.stringify(fields) });
      }
    }
    async function deleteTask(siteId, taskListId, itemId) {
      return graphFetch(`/sites/${siteId}/lists/${taskListId}/items/${itemId}`, { method:"DELETE" });
    }

    /******************** Documents: TaskPhotos folder & uploads ********************/
    async function ensureTaskPhotosFolder(siteId) {
      try {
        const folder = await graphFetch(`/sites/${siteId}/drive/root:/TaskPhotos`);
        return folder;
      } catch {
        return graphFetch(`/sites/${siteId}/drive/root/children`, {
          method:"POST",
          body: JSON.stringify({ name:"TaskPhotos", folder:{}, "@microsoft.graph.conflictBehavior":"rename" })
        });
      }
    }
    async function uploadSmall(siteId, name, blob) {
      const token = await getGraphToken();
      const res = await fetch(`${CONFIG.graphBase}/sites/${siteId}/drive/root:/TaskPhotos/${encodeURIComponent(name)}:/content`, {
        method:"PUT", headers:{ "Authorization": `Bearer ${token}` }, body: blob
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    async function uploadLarge(siteId, name, blob) {
      const session = await graphFetch(`/sites/${siteId}/drive/root:/TaskPhotos/${encodeURIComponent(name)}:/createUploadSession`, {
        method:"POST", body: JSON.stringify({ item: { "@microsoft.graph.conflictBehavior":"replace" } })
      });
      const url = session.uploadUrl;
      const chunkSize = 5 * 1024 * 1024; // 5MB
      let offset = 0;
      while (offset < blob.size) {
        const end = Math.min(offset + chunkSize, blob.size);
        const chunk = blob.slice(offset, end);
        const res = await fetch(url, {
          method:"PUT", headers:{ "Content-Range": `bytes ${offset}-${end-1}/${blob.size}` }, body: chunk
        });
        if (!res.ok) throw new Error(await res.text());
        offset = end;
      }
    }
    async function uploadTaskPhotos(siteId, files) {
      await ensureTaskPhotosFolder(siteId);
      const results = [];
      for (const file of files) {
        if (file.size <= 4*1024*1024) results.push(await uploadSmall(siteId, file.name, file));
        else { await uploadLarge(siteId, file.name, file); results.push({ name:file.name, status:"uploaded" }); }
      }
      return results;
    }

    /******************** State ********************/
    const ctx = { siteId:null, taskListId:null, projectListId:null, role:"viewer", projects:[], tasks:[] };
    const debounce = (fn, ms=600) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); }; };

    /******************** UI wiring ********************/
    function wireEditors() {
      $("btnAddProject").onclick = () => openProjectModal();
      $("btnAddTask").onclick = () => openTaskModal();
      $("btnCloseProject").onclick = () => $("projectModal").close();
      $("btnCloseTask").onclick = () => $("taskModal").close();

      const projectForm = $("projectForm");
      projectForm.oninput = debounce(async () => {
        const fields = collectProjectFields();
        const itemId = projectForm.dataset.itemId || null;
        const resp = await createOrUpdateProject(ctx.siteId, ctx.projectListId, itemId, fields);
        if (!itemId) projectForm.dataset.itemId = resp.id;
        await loadProjectsTop8();
      }, 900);

      projectForm.onsubmit = async (e) => {
        e.preventDefault();
        const fields = collectProjectFields();
        const itemId = projectForm.dataset.itemId || null;
        await createOrUpdateProject(ctx.siteId, ctx.projectListId, itemId, fields);
        await loadProjectsTop8();
        $("projectModal").close();
      };
      $("btnDeleteProject").onclick = async () => {
        if (ctx.role !== "admin") return;
        const itemId = projectForm.dataset.itemId;
        if (itemId) { await deleteProject(ctx.siteId, ctx.projectListId, itemId); await loadProjectsTop8(); $("projectModal").close(); }
      };

      const taskForm = $("taskForm");
      taskForm.onsubmit = async (e) => {
        e.preventDefault();
        const fields = collectTaskFields();
        const itemId = taskForm.dataset.itemId || null;
        await createOrUpdateTask(ctx.siteId, ctx.taskListId, itemId, fields);

        const files = Array.from($("taskPhotos").files||[]);
        if (files.length) await uploadTaskPhotos(ctx.siteId, files);

        await loadTasks();
        $("taskModal").close();
      };
      $("btnDeleteTask").onclick = async () => {
        if (ctx.role !== "admin") return;
        const itemId = taskForm.dataset.itemId;
        if (itemId) { await deleteTask(ctx.siteId, ctx.taskListId, itemId); await loadTasks(); $("taskModal").close(); }
      };
    }

    function openProjectModal(item=null) {
      const dlg = $("projectModal");
      const form = $("projectForm"); form.reset(); form.dataset.itemId = "";
      if (item) {
        const f = item.fields||{};
        form.Title.value = f.Title||"";
        form.Owner.value = f.Owner||"";
        form.StartDate.value = (f.StartDate||"").split("T")[0];
        form.ExpectedSales.value = f.ExpectedSales||"";
        form.Active.checked = !!f.Active;
        form.dataset.itemId = item.id;
      }
      dlg.showModal();
    }
    function openTaskModal(item=null) {
      const dlg = $("taskModal");
      const form = $("taskForm"); form.reset(); form.dataset.itemId = "";
      $("taskPhotos").value = "";
      if (item) {
        const f = item.fields||{};
        form.Title.value = f.Title||"";
        form.Address.value = f.Address||"";
        form.StartDate.value = (f.StartDate||"").split("T")[0];
        form.EndDate.value = (f.EndDate||"").split("T")[0];
        form.Quantity.value = f.Quantity||"";
        form.UnitCost.value = f.UnitCost||"";
        form.TotalCost.value = f.TotalCost||"";
        form.Allocation.value = f.Allocation||"";
        form.Sprint.value = f.Sprint||"";
        form.Assignee.value = f.Assignee||"";
        form.Description.value = f.Description||"";
        form.Notes.value = f.Notes||"";
        form.dataset.itemId = item.id;
      }
      dlg.showModal();
    }
    function collectProjectFields() {
      const f = $("projectForm");
      return {
        Title: f.Title.value.trim(),
        Owner: f.Owner.value.trim(),
        StartDate: f.StartDate.value || null,
        ExpectedSales: f.ExpectedSales.value ? Number(f.ExpectedSales.value) : null,
        Active: f.Active.checked
      };
    }
    function collectTaskFields() {
      const f = $("taskForm");
      return {
        Title: f.Title.value.trim(),
        Address: f.Address.value.trim(),
        StartDate: f.StartDate.value || null,
        EndDate: f.EndDate.value || null,
        Quantity: f.Quantity.value ? Number(f.Quantity.value) : null,
        UnitCost: f.UnitCost.value ? Number(f.UnitCost.value) : null,
        TotalCost: f.TotalCost.value ? Number(f.TotalCost.value) : null,
        Allocation: f.Allocation.value ? Number(f.Allocation.value) : null,
        Sprint: f.Sprint.value.trim(),
        Assignee: f.Assignee.value.trim(),
        Description: f.Description.value.trim(),
        Notes: f.Notes.value.trim()
      };
    }
    const esc = s => String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    /******************** Loaders ********************/
    async function loadProjectsTop8() {
      const data = await getTopProjects(ctx.siteId, ctx.projectListId, 8);
      ctx.projects = data.value || [];
      const tbody = $("projectTable").querySelector("tbody");
      tbody.innerHTML = "";
      for (const it of ctx.projects) {
        const f = it.fields||{};
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(f.Title)}</td>
          <td>${esc(f.Owner)}</td>
          <td>${esc((f.StartDate||"").split("T")[0])}</td>
          <td>${esc(f.ExpectedSales)}</td>
          <td>${f.Active ? "✔" : ""}</td>
          <td>
            ${ctx.role==="viewer" ? "" : `<button class="btn-edit">Edit</button>`}
            ${ctx.role==="admin" ? `<button class="btn-del">Delete</button>` : ""}
          </td>`;
        if (ctx.role!=="viewer") tr.querySelector(".btn-edit").onclick = () => openProjectModal(it);
        if (ctx.role==="admin") tr.querySelector(".btn-del").onclick = async () => { await deleteProject(ctx.siteId, ctx.projectListId, it.id); await loadProjectsTop8(); };
        tbody.appendChild(tr);
      }
      $("statTotalProjects").textContent = ctx.projects.length;
      $("statActiveProjects").textContent = ctx.projects.filter(p=>p.fields?.Active).length;
    }
    async function loadTasks() {
      const data = await getTasks(ctx.siteId, ctx.taskListId);
      ctx.tasks = data.value || [];
      const tbody = $("taskTable").querySelector("tbody");
      tbody.innerHTML = "";
      for (const it of ctx.tasks) {
        const f = it.fields||{};
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(f.Title)}</td>
          <td>${esc(f.Address)}</td>
          <td>${esc((f.StartDate||"").split("T")[0])}</td>
          <td>${esc((f.EndDate||"").split("T")[0])}</td>
          <td>${esc(f.Quantity)}</td>
          <td>${esc(f.UnitCost)}</td>
          <td>${esc(f.TotalCost)}</td>
          <td>${esc(f.Allocation)}</td>
          <td>${esc(f.Sprint)}</td>
          <td>${esc(f.Assignee)}</td>
          <td>
            ${ctx.role==="viewer" ? "" : `<button class="btn-edit">Edit</button>`}
            ${ctx.role==="admin" ? `<button class="btn-del">Delete</button>` : ""}
          </td>`;
        if (ctx.role!=="viewer") tr.querySelector(".btn-edit").onclick = () => openTaskModal(it);
        if (ctx.role==="admin") tr.querySelector(".btn-del").onclick = async () => { await deleteTask(ctx.siteId, ctx.taskListId, it.id); await loadTasks(); };
        tbody.appendChild(tr);
      }
    }

    /******************** Boot ********************/
    async function boot() {
      const ids = await resolveSiteAndLists();
      ctx.siteId = ids.siteId; ctx.taskListId = ids.taskListId; ctx.projectListId = ids.projectListId;
      ctx.role = getRole();
      applyRBAC();
      wireEditors();
      await loadProjectsTop8();
      await loadTasks();
    }

    /******************** Startup ********************/
    document.addEventListener("DOMContentLoaded", async () => {
      $("btnSignIn").onclick = signIn;
      $("btnSignInCard").onclick = signIn;
      $("btnSignOut").onclick = signOut;

      await msalInstance.initialize();
      const accts = msalInstance.getAllAccounts();
      if (accts.length) {
        msalInstance.setActiveAccount(accts[0]);
        showSignedIn(accts[0]);
        await boot();
      } else {
        showSignedOut();
      }
    });
  </script>
</body>
</html>
